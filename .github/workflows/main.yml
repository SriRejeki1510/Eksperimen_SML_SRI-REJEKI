# File: .github/workflows/main.yml

name: Run MLflow Model CI

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  run-mlflow-project:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository (full history to avoid cache issues)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # Ini akan mengambil seluruh riwayat, memaksa checkout baru

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'

      - name: Install MLflow CLI
        run: |
          python -m pip install --upgrade pip
          pip install mlflow

      - name: Install Miniconda, Initialize Shell, and Run MLflow Project
        shell: bash
        run: |
          # 1. Install Miniconda jika belum ada
          if ! command -v conda &> /dev/null
          then
              echo "Conda not found, installing Miniconda..."
              wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
              bash miniconda.sh -b -p $HOME/miniconda
              rm miniconda.sh
              source $HOME/miniconda/etc/profile.d/conda.sh
              echo "Conda successfully installed and initialized."
          else
              echo "Conda is already installed."
              source $(conda info --base)/etc/profile.d/conda.sh
          fi

          # Opsional: Update Conda
          conda update -n base -c defaults conda || true

          # Navigasi ke direktori proyek MLflow Anda
          cd Workflow-CI/MLProject/

          # >>>>>> PERUBAHAN SANGAT KRUSIAL DI SINI <<<<<<
          # Hapus file CSV yang mungkin masih rusak di runner
          echo "Attempting to remove potentially cached/corrupted CSV file in runner..."
          rm -f wine_quality_preprocessing/wine_quality_preprocessed.csv || true
          echo "Removed. Now trying to re-download the clean version from GitHub raw."

          # Dapatkan URL mentah (raw) dari file CSV di GitHub Anda
          # Ganti `your-username` dan `your-repo-name` dengan nama Anda dan repositori Anda
          # Menggunakan `raw.githubusercontent.com` untuk mendapatkan file mentah
          RAW_CSV_URL="https://raw.githubusercontent.com/SriRejeki1510/Eksperimen_SML_SRI-REJEKI/main/Workflow-CI/MLProject/wine_quality_preprocessing/wine_quality_preprocessed.csv"
          
          # Buat direktori jika belum ada (opsional, tapi aman)
          mkdir -p wine_quality_preprocessing/

          # Download ulang file CSV yang bersih
          echo "Downloading clean CSV from $RAW_CSV_URL..."
          wget -q $RAW_CSV_URL -O wine_quality_preprocessing/wine_quality_preprocessed.csv
          
          # Verifikasi ukuran file yang didownload
          ls -lh wine_quality_preprocessing/wine_quality_preprocessed.csv

          # Debugging logs
          echo "Listing contents of the MLflow Project directory (current working directory): $(pwd)"
          ls -F
          echo "---"

          # Verifikasi ISI FILE CSV DI RUNTIME ACTIONS - HARUS BERSIH SEKARANG!
          echo "Verifying content of wine_quality_preprocessed.csv at line 1360-1365 (after re-download):"
          sed -n '1360,1365p' wine_quality_preprocessing/wine_quality_preprocessed.csv || true
          echo "--- End of verification ---"


          # Verifikasi MLproject dan conda.yaml ada (seperti sebelumnya)
          if [ -f "MLproject" ] && [ -f "conda.yaml" ]; then
            echo "MLproject and conda.yaml files found!"
            echo "--- MLproject content ---"
            cat MLproject
            echo "--- conda.yaml content ---"
            cat conda.yaml
            echo "---"
          else
            echo "Error: MLproject or conda.yaml file not found in the current directory!"
            exit 1
          fi

          export MLFLOW_TRACKING_URI=./mlruns

          mlflow run .